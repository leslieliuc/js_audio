<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
    <title>聲音判斷實驗</title>
    <style>
        body { background-color: black; color: white; }
        #jspsych-target {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* 讓區塊填滿整個螢幕 */
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>
    <script>
        var jsPsych = initJsPsych({
            display_element: 'jspsych-target',  // 確保顯示區域正確
            on_finish: function() {
                sendDataToGoogleSheets(jsPsych.data.get().json());
            }
        });

        var timeline = [];

        // 歡迎頁面
        const welcome = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p>感謝你參與實驗, 按任意鍵繼續</p>'
        };
        timeline.push(welcome);

        // 同意書
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `  
                <div style="text-align: justify;">
                    <p>感謝你參加本次實驗，以下是實驗相關內容與同意參加確認。</p>
                    <p>實驗目的:字形相異判斷與反應時間</p>
                    <p>研究方法與程序:閱讀本頁面後，你會進入練習的部分，此部分主要是讓你熟悉實驗中會用到的反應按鍵，以及你所需要的操作。預計有五題。</p>
                    <p>接著便是正式實驗，時間約為30分鐘。</p>
                    <p>實驗副作用:實驗不會帶來任何副作用</p>
                    <p>實驗退出及中止:你可以隨時撤銷同意或中止實驗。</p>
                    <p>本實驗由國立台灣師範大學李俊仁老師實驗室發布</p>
                    <p>按任意鍵繼續</p>
                </div>`
        });

        // 受試者姓名和日期輸入
       var nameAndDateInput = {
          type: jsPsychSurveyHtmlForm,
          preamble: '<p>請輸入您的姓名以及今日日期</p>',
          html: ` 
            <p>本人 <input id="first" name="first" type="text" placeholder="姓名" /> 已看完上頁內容, 
            於 <input name="second" type="text" placeholder="日期" /> 同意參加本實驗。</p>
          `,
          autofocus: 'first',
          on_finish: function(data) {
            jsPsych.data.addProperties({
              name: data.response.first,
              date: data.response.second
            });
          }
        };
        timeline.push(nameAndDateInput);

        // 受試者編碼輸入
        const code_entry = {
            type: jsPsychSurveyHtmlForm,
            preamble: '<p>請輸入您的受試者編碼：</p>',
            html: '<p>受試者編碼: <input type="text" name="subject_code" size="10" required /></p>',
            autofocus: true,
            on_finish: function(data) {
                jsPsych.data.addProperties({
                    subject_code: data.response.subject_code
                });
            }
        };
        timeline.push(code_entry);

        // 任務說明
        const introduction = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p>每回合你會聽到兩個聲音，請判斷聲音是否相同</p>' +
                      '<p>當聲音相同，請按 <strong>Z 鍵</strong>，不同按 <strong>/ 鍵</strong></p>' +
                      '<p>按任意鍵繼續</p>'
        };
        timeline.push(introduction);

        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: 1000,
            data: { task: 'fixation' }
            };

        // 聲音刺激
        var sounds = ['https://leslieliuc.github.io/js_audio/A.wav', 'https://leslieliuc.github.io/js_audio/B.wav', 'https://leslieliuc.github.io/js_audio/C.wav',
                      'https://leslieliuc.github.io/js_audio/D.wav', 'https://leslieliuc.github.io/js_audio/E.wav', 'https://leslieliuc.github.io/js_audio/F.wav',
                      'https://leslieliuc.github.io/js_audio/G.wav', 'https://leslieliuc.github.io/js_audio/da.wav', 'https://leslieliuc.github.io/js_audio/da3.wav', 'https://leslieliuc.github.io/js_audio/du.wav'];

        function createSoundTrial() {
            let chosen_sounds = jsPsych.randomization.sampleWithoutReplacement(sounds, 2);
            
            var sound_trial_1 = {
                type: jsPsychAudioKeyboardResponse,
                stimulus: chosen_sounds[0],
                prompt: "<p>第一個聲音播放中...</p>",
                choices: "NO_KEYS",
                trial_ends_after_audio: true
            };

            var sound_trial_2 = {
                type: jsPsychAudioKeyboardResponse,
                stimulus: chosen_sounds[1],
                prompt: "<p>第二個聲音播放中...</p>",
                choices: "NO_KEYS",
                trial_ends_after_audio: true
            };

            var judgment_screen = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "<p>請判斷兩個聲音是否相同</p>" +
                          "<p>如果相同，請按 <strong>z</strong>，如果不同，請按 <strong>/</strong></p>",
                choices: ['z', '/'],
                on_finish: function(data) {
                    var correct_response = (chosen_sounds[0] === chosen_sounds[1]) ? 'z' : '/';
                    data.correct = (data.response === correct_response) ? 1 : 0;
                    data.correct_response = correct_response;
                    data.sound_trial_1 = chosen_sounds[0];
                    data.sound_trial_2 = chosen_sounds[1];
                }
            };

            return [fixation,sound_trial_1, sound_trial_2, judgment_screen];
        }

        for (let i = 0; i < 11; i++) {
            timeline.push(...createSoundTrial());
        }

        function sendDataToGoogleSheets(data) {
            fetch("https://script.google.com/macros/s/AKfycbzzPZjDYl8hIMRJu-ItYw5PYPDciqw9HD8xQs5qz-diK5uHQARaUX4WQ9k5uJqslYPn/exec", {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ experiment_data: data })
            });
        }

        jsPsych.run(timeline);
    </script>
</body>
</html>
